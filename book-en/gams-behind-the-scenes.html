<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 GAMs behind the scenes | Workshop 8: Generalized additive models in R</title>
  <meta name="description" content="Generalized additive models in R" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 GAMs behind the scenes | Workshop 8: Generalized additive models in R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://github.com/qcbsRworkshops/" />
  <meta property="og:image" content="https://github.com/qcbsRworkshops//assets/images/logo/csbq_logo_accueil.png" />
  <meta property="og:description" content="Generalized additive models in R" />
  <meta name="github-repo" content="qcbsRworkshops/workshop08" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 GAMs behind the scenes | Workshop 8: Generalized additive models in R" />
  
  <meta name="twitter:description" content="Generalized additive models in R" />
  <meta name="twitter:image" content="https://github.com/qcbsRworkshops//assets/images/logo/csbq_logo_accueil.png" />

<meta name="author" content="Developed and maintained by the contributors of the QCBS R Workshop Series" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="assets/images/favicon.ico" type="image/x-icon" />
<link rel="prev" href="quick-intro-to-generalized-additive-mixed-models-gamms.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="assets/qcbs-style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo"><a href="./"><img src="assets/images/csbq_logo_gray_accueil.png"></a></li>
<link rel="icon" type="image/png" href="assets/images/favicon.ico"/>

<li class="divider"></li>
<li class="part"><span><b>QCBS R Workshop Series</b></span></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#code-of-conduct"><i class="fa fa-check"></i><b>0.1</b> Code of conduct</a><ul>
<li class="chapter" data-level="0.1.1" data-path="index.html"><a href="index.html#expected-behaviour"><i class="fa fa-check"></i><b>0.1.1</b> Expected behaviour</a></li>
<li class="chapter" data-level="0.1.2" data-path="index.html"><a href="index.html#unacceptable-behaviour"><i class="fa fa-check"></i><b>0.1.2</b> Unacceptable behaviour</a></li>
</ul></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#contributors"><i class="fa fa-check"></i><b>0.2</b> Contributors</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#contributing"><i class="fa fa-check"></i><b>0.3</b> Contributing</a></li>
</ul></li>
<li class="part"><span><b>Generalized Additive Models in <code>R</code></b></span></li>
<li class="chapter" data-level="1" data-path="summary-and-learning-objectives.html"><a href="summary-and-learning-objectives.html"><i class="fa fa-check"></i><b>1</b> Summary and Learning objectives</a><ul>
<li class="chapter" data-level="1.1" data-path="summary-and-learning-objectives.html"><a href="summary-and-learning-objectives.html#summary"><i class="fa fa-check"></i><b>1.1</b> Summary</a></li>
<li class="chapter" data-level="1.2" data-path="summary-and-learning-objectives.html"><a href="summary-and-learning-objectives.html#learning-objectives"><i class="fa fa-check"></i><b>1.2</b> Learning Objectives</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="preparing-for-the-workshop.html"><a href="preparing-for-the-workshop.html"><i class="fa fa-check"></i><b>2</b> Preparing for the workshop</a></li>
<li class="chapter" data-level="3" data-path="the-linear-modeland-where-if-fails.html"><a href="the-linear-modeland-where-if-fails.html"><i class="fa fa-check"></i><b>3</b> The linear model…and where if fails</a></li>
<li class="chapter" data-level="4" data-path="introduction-to-gams.html"><a href="introduction-to-gams.html"><i class="fa fa-check"></i><b>4</b> Introduction to GAMs</a><ul>
<li class="chapter" data-level="4.1" data-path="introduction-to-gams.html"><a href="introduction-to-gams.html#challenge-1"><i class="fa fa-check"></i><b>4.1</b> Challenge 1</a><ul>
<li class="chapter" data-level="4.1.1" data-path="introduction-to-gams.html"><a href="introduction-to-gams.html#challenge-1-solution"><i class="fa fa-check"></i><b>4.1.1</b> Challenge 1 Solution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="multiple-smooth-terms.html"><a href="multiple-smooth-terms.html"><i class="fa fa-check"></i><b>5</b> Multiple smooth terms</a><ul>
<li class="chapter" data-level="5.1" data-path="multiple-smooth-terms.html"><a href="multiple-smooth-terms.html#challenge-2"><i class="fa fa-check"></i><b>5.1</b> CHALLENGE 2</a><ul>
<li class="chapter" data-level="5.1.1" data-path="multiple-smooth-terms.html"><a href="multiple-smooth-terms.html#challenge-2-solution"><i class="fa fa-check"></i><b>5.1.1</b> Challenge 2 solution</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="interactions.html"><a href="interactions.html"><i class="fa fa-check"></i><b>6</b> Interactions</a></li>
<li class="part"><span><b>Advanced Concepts</b></span></li>
<li class="chapter" data-level="7" data-path="changing-the-basis.html"><a href="changing-the-basis.html"><i class="fa fa-check"></i><b>7</b> Changing the Basis</a></li>
<li class="chapter" data-level="8" data-path="other-distributions.html"><a href="other-distributions.html"><i class="fa fa-check"></i><b>8</b> Other distributions</a><ul>
<li class="chapter" data-level="8.1" data-path="other-distributions.html"><a href="other-distributions.html#visualizing-the-trend-over-time"><i class="fa fa-check"></i><b>8.1</b> Visualizing the trend over time</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="quick-intro-to-generalized-additive-mixed-models-gamms.html"><a href="quick-intro-to-generalized-additive-mixed-models-gamms.html"><i class="fa fa-check"></i><b>9</b> Quick intro to Generalized Additive Mixed Models (GAMMs)</a><ul>
<li class="chapter" data-level="9.1" data-path="quick-intro-to-generalized-additive-mixed-models-gamms.html"><a href="quick-intro-to-generalized-additive-mixed-models-gamms.html#dealing-with-non-independence"><i class="fa fa-check"></i><b>9.1</b> Dealing with non-independence</a></li>
<li class="chapter" data-level="9.2" data-path="quick-intro-to-generalized-additive-mixed-models-gamms.html"><a href="quick-intro-to-generalized-additive-mixed-models-gamms.html#mixed-modelling"><i class="fa fa-check"></i><b>9.2</b> Mixed modelling</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="gams-behind-the-scenes.html"><a href="gams-behind-the-scenes.html"><i class="fa fa-check"></i><b>10</b> GAMs behind the scenes</a><ul>
<li class="chapter" data-level="10.1" data-path="gams-behind-the-scenes.html"><a href="gams-behind-the-scenes.html#a-simple-example-a-polynomial-basis"><i class="fa fa-check"></i><b>10.1</b> A simple example: a polynomial basis</a></li>
<li class="chapter" data-level="10.2" data-path="gams-behind-the-scenes.html"><a href="gams-behind-the-scenes.html#another-example-a-cubic-spline-basis"><i class="fa fa-check"></i><b>10.2</b> Another example: a cubic spline basis</a><ul>
<li class="chapter" data-level="10.2.1" data-path="gams-behind-the-scenes.html"><a href="gams-behind-the-scenes.html#controlling-the-degree-of-smoothing-with-penalized-regression-splines"><i class="fa fa-check"></i><b>10.2.1</b> Controlling the degree of smoothing with penalized regression splines</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="gams-behind-the-scenes.html"><a href="gams-behind-the-scenes.html#illustration-of-the-principle-behind-cross-validation"><i class="fa fa-check"></i><b>10.3</b> Illustration of the principle behind cross validation</a></li>
<li class="chapter" data-level="10.4" data-path="gams-behind-the-scenes.html"><a href="gams-behind-the-scenes.html#brief-note-on-effective-degrees-of-freedom-edf"><i class="fa fa-check"></i><b>10.4</b> Brief note on effective degrees of freedom (edf)</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>11</b> References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/qcbsRworkshops" target="blank">QCBS R Workshop Series</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Workshop 8: Generalized additive models in <code>R</code></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!------------------------ Hero Image Container --------------------------> 

<head>
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=10.0,initial-scale=1.0">
  <script src="https://kit.fontawesome.com/6a26f47516.js"></script>
  <script src="assets/qcbs-hideOutput.js"></script>
  <link href="assets/qcbs-style.css" rel="stylesheet">
</head>



<div class="hero-image-container"> 
  <img class= "hero-image" src="assets/images/jean-philippe-delberghe-75xPHEQBmvA-unsplash_hero_image.jpg">
</div>
<div id="gams-behind-the-scenes" class="section level1">
<h1><span class="header-section-number">Chapter 10</span> GAMs behind the scenes</h1>
<p>We will now take a few minutes to look at what GAMs are doing behind the
scenes. Lets first consider a model containing one smooth function of
one covariate, <em>x<sub>i</sub></em>:</p>
<p><span class="math display">\[y_i = f(x_i) + ε_i\]</span></p>
<p>To estimate the smooth function <em>f</em>, we need to represented the above
equation in such a way that it becomes a linear model. This can be done
by choosing a basis, <em>b<sub>i</sub>(x)</em>, defining the space of functions of which
<em>f</em> is an element:</p>
<p><span class="math display">\[f(x) = \sum_{i=1}^{q}b_i(x)β_i\]</span></p>
<div id="a-simple-example-a-polynomial-basis" class="section level2">
<h2><span class="header-section-number">10.1</span> A simple example: a polynomial basis</h2>
<p>Suppose that <em>f</em> is believed to be a 4<sup>th</sup> order polynomial, so that the
space of polynomials of order 4 and below contains <em>f</em>. A basis for this
space would then be:</p>
<p><span class="math display">\[b_1(x)=1, b_2(x)=x, b_3(x)=x^2, b_4(x)=x^3,
b_5(x)=x^4\]</span></p>
<p>so that <em>f(x)</em> becomes:</p>
<p><span class="math display">\[f(x) = β_1 + x_iβ_2 + x^2_iβ_3 +
x^3_iβ_4(x) + x^4_iβ_5\]</span></p>
<p>and the full model now becomes:</p>
<p><span class="math display">\[y_i = β_1 + x_iβ_2 + x^2_iβ_3 +
x^3_iβ_4(x) + x^4_iβ_5 + ε_i\]</span></p>
<p>The basis functions are each multiplied by a real valued parameter,
<em>β<sub>i</sub></em>, and are then summed to give the <strong>final curve</strong> <em>f(x)</em>.</p>
<p><img src="images/polynomial_basis_example.png" width="600" /></p>
<p>By varying the <em>β<sub>i</sub></em> we can vary the form of <em>f(x)</em> to produce any
polynomial function of order 4 or lower.</p>
</div>
<div id="another-example-a-cubic-spline-basis" class="section level2">
<h2><span class="header-section-number">10.2</span> Another example: a cubic spline basis</h2>
<p>A cubic spline is a curve constructed from sections of a cubic
polynomial joined together so that they are continuous in value. Each
section of cubic has different coefficients.</p>
<p><img src="images/cubic_spline.png" width="450" /></p>
<p>Here’s a representation of a smooth function using a rank 5 cubic
spline basis with knot locations at increments of 0.2:</p>
<p><img src="images/graphic6.1.jpg" width="300" /></p>
<p>In this example, the knots are evenly spaced through the range of
observed x values. However, the choice of the degree of model smoothness
is controlled by the the number of knots, which was arbitrary. Is there
a better way to select the knot locations?</p>
<div id="controlling-the-degree-of-smoothing-with-penalized-regression-splines" class="section level3">
<h3><span class="header-section-number">10.2.1</span> Controlling the degree of smoothing with penalized regression splines</h3>
<p>Instead of controlling smoothness by altering the number of knots, we
keep that fixed to size a little larger than reasonably necessary, and
control the model’s smoothness by adding a “wiggleness” penalty.</p>
<p>So, rather than fitting the model by minimizing (as with least squares
regression):</p>
<p><span class="math display">\[||y - XB||^2\]</span></p>
<p>it can be fit by minimizing:</p>
<p><span class="math display">\[||y - XB||^2 + \lambda \int_0^1 [f&#39;&#39;(x)]^2 dx\]</span></p>
<p>As <em>λ</em> goes to <em>∞</em>, the model becomes
linear. The selection of the best fit smoothing parameter, <em>λ</em>,
makes use of a cross-validation approach. If <em>λ</em>
is too high then the data will be over smoothed, and if it is too low
then the data will be under smoothed. Ideally, it would be good to
choose <em>λ</em> so that the <em>predicted f</em> is as close as
possible to <em>f</em>. A suitable criterion might be to choose <em>λ</em> to minimize:</p>
<p><span class="math display">\[M = \frac{1}{n} \sum_{i=1}^{n}(\hat{f_i} - f_i)^2\]</span></p>
<p>Since <em>f</em> is unknown, <em>M</em> is estimated using a generalized cross
validation technique that leaves out each datum from the data in turn
and considers the average ability of models fitted to the remaining data
to predict the left out datum (for further details, see Wood 2006).</p>
</div>
</div>
<div id="illustration-of-the-principle-behind-cross-validation" class="section level2">
<h2><span class="header-section-number">10.3</span> Illustration of the principle behind cross validation</h2>
<p><img src="images/illustration_of_smooth_sel.png" width="600" /></p>
<p>In the first panel, the curve fits many of the data poorly and does no
better with the missing point. In the third panel, the curve fits the
noise as well as the signal and the extra variability induced causes it
to predict the missing datum rather poorly. In the second panel,
however, we see that the curve fits the underlying signal quite well,
smoothing through the noise and the missing datum is reasonably well
predicted.</p>
<p><img src="images/gcv.png" width="600" /></p>
</div>
<div id="brief-note-on-effective-degrees-of-freedom-edf" class="section level2">
<h2><span class="header-section-number">10.4</span> Brief note on effective degrees of freedom (edf)</h2>
<p>How many degrees of freedom does a fitted GAM have?</p>
<p>Instead of providing the output of the cross-validation in terms of
<em>λ</em> (some tuning parameter modulating the fit’s
complexity), the <code>gam()</code> function in the <code>mgcv</code> package uses a term called
the effective degrees of freedom (edf) as a consistent way to quantify
model complexity (that is, to justify our intuition that the degrees of
freedom tracks model complexity). Because the number of free parameters
in GAMs is difficult to define, the edf are instead related to <em>λ</em>,
where the effect of the penalty is to reduce the
effective degrees of freedom. So let’s say the arbitrarily large number
of knots is set to <em>k=10</em>, then <em>k-1</em> sets the upper limit on the degrees of
freedom associated with a smooth term. This number then decreases as the
penalty <em>λ</em> increases until the best fit penalty is
found by cross-validation.</p>

</div>
</div>
<hr>
<center> 
  <div class="footer">
      All the content of the workshop series is under a <a href="https://creativecommons.org/licenses/by-nc/2.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
  </div>
</center>
            </section>

          </div>
        </div>
      </div>
<a href="quick-intro-to-generalized-additive-mixed-models-gamms.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
